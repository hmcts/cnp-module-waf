{
  "$schema":
    "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string"
    },
    "appGatewaySettings": {
      "type": "object"
    },
    "authenticationCertificates": {
      "type": "array"
    },
    "sslCertificates": {
      "type": "array"
    },
    "gatewayIPConfigurations": {
      "type": "array"
    },
    "frontendIPConfigurations": {
      "type": "array"
    },
    "frontendPorts": {
      "type": "array"
    },
    "backendAddressPools": {
      "type": "array"
    },
    "backendHttpSettingsCollection": {
      "type": "array"
    },
    "httpListeners": {
      "type": "array"
    },
    "requestRoutingRules": {
      "type": "array"
    },
    "requestRoutingRulesPathBased": {
      "type": "array"
    },
    "urlPathMaps": {
      "type": "array"
    },
    "probes": {
      "type": "array"
    },
    "wafEnabled": {
      "type": "string"
    },
    "wafMode": {
      "type": "string"
    },
    "wafRuleSetType": {
      "type": "string"
    },
    "wafRuleSetVersion": {
      "type": "string"
    },
    "sslPolicy": {
      "type": "string"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string"
    },
    "wafMaxRequestBodySize": {
      "type": "string"
    },
    "wafFileUploadLimit": {
      "type": "string"
    }
  },
  "variables": {},
  "resources": [
    {
      "apiVersion": "2017-03-01",
      "type": "Microsoft.Network/publicIPAddresses",
      "name":
        "[parameters('appGatewaySettings').frontendIPConfigurations[copyindex()].PublicIPName]",
      "location": "[resourcegroup().location]",
      "properties": {
        "publicIPAllocationMethod": "Dynamic"
      },
      "copy": {
        "count":
          "[length(parameters('appGatewaySettings').frontendIPConfigurations)]",
        "mode": "Serial",
        "name": "pipCopy"
      }
    },
    {
      "apiVersion": "2018-11-01",
      "name": "[parameters('appGatewaySettings').name]",
      "type": "Microsoft.Network/applicationGateways",
      "location": "[parameters('location')]",
      "dependsOn": ["pipCopy"],
      "properties": {
        "sku": {
          "name": "[parameters('appGatewaySettings').size]",
          "tier": "[parameters('appGatewaySettings').tier]",
          "capacity": "[parameters('appGatewaySettings').capacity]"
        },
        "gatewayIPConfigurations": "[parameters('gatewayIPConfigurations')]",
        "authenticationCertificates":
          "[parameters('authenticationCertificates')]",
        "frontendIPConfigurations": "[parameters('frontendIPConfigurations')]",
        "frontendPorts": "[parameters('frontendPorts')]",
        "backendAddressPools": "[parameters('backendAddressPools')]",
        "backendHttpSettingsCollection":
          "[parameters('backendHttpSettingsCollection')]",
        "httpListeners": "[parameters('httpListeners')]",
        "requestRoutingRules": "[concat(parameters('requestRoutingRules'), parameters('requestRoutingRulesPathBased'))]",
        "urlPathMaps": "[parameters('urlPathMaps')]",
        "sslCertificates": "[parameters('sslCertificates')]",
        "probes": "[parameters('probes')]",
        "webApplicationFirewallConfiguration": {
          "enabled": "[parameters('wafEnabled')]",
          "firewallMode": "[parameters('wafMode')]",
          "ruleSetType": "[parameters('wafRuleSetType')]",
          "ruleSetVersion": "[parameters('wafRuleSetVersion')]",
          "disabledRuleGroups": [
            {
              "ruleGroupName": "REQUEST-931-APPLICATION-ATTACK-RFI",
              "rules":[
                931130
              ]
            },
            {
              "ruleGroupName": "REQUEST-930-APPLICATION-ATTACK-LFI",
              "rules":[
                930130,
                930110,
                930100
              ]
            },
            {
              "ruleGroupName": "REQUEST-933-APPLICATION-ATTACK-PHP",
              "rules":[
                933160
              ]
            },
            {
              "ruleGroupName": "REQUEST-911-METHOD-ENFORCEMENT",
              "rules":[
                911100
              ]
            },
            {
              "ruleGroupName": "REQUEST-932-APPLICATION-ATTACK-RCE",
              "rules":[
                932140,
                932100,
                932110,
                932115,
                932105,
                932150,
                932130
              ]
            },
            {
              "ruleGroupName": "REQUEST-913-SCANNER-DETECTION",
              "rules":[
                913101,
                913102
              ]
            },
            {
              "ruleGroupName": "REQUEST-920-PROTOCOL-ENFORCEMENT",
              "rules":[
                920300,
                920440,
                920320,
                920230,
                920271,
                920270,
                920330,
                920450
              ]
            },
            {
              "ruleGroupName": "REQUEST-921-PROTOCOL-ATTACK",
              "rules":[
                921110,
                921120
              ]
            },
            {
              "ruleGroupName": "REQUEST-941-APPLICATION-ATTACK-XSS",
              "rules":[
                941160,
                941330,
                941340,
                941100,
                941130,
                941140,
                941150,
                941200,
                941310,
                941320,
                941350,
                941180,
                941120,
                941170
              ]
            },
            {
              "ruleGroupName": "REQUEST-942-APPLICATION-ATTACK-SQLI",
              "rules":[
                942200,
                942260,
                942340,
                942370,
                942430,
                942440,
                942210,
                942450,
                942130,
                942400,
                942150,
                942410,
                942330,
                942190,
                942310,
                942380,
                942240,
                942110,
                942250,
                942180,
                942390,
                942300,
                942230,
                942100,
                942120,
                942360,
                942140,
                942270,
                942350,
                942320
              ]
            }
          ],
          "maxRequestBodySizeInKb": "[parameters('wafMaxRequestBodySize')]",
          "fileUploadLimitInMb": "[parameters('wafFileUploadLimit')]"
        },
        "sslPolicy": {
          "policyType": "Custom",
          "cipherSuites":["TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384","TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256","TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384","TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256","TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA"],
          "minProtocolVersion": "TLSv1_2"
        }
      },
      "resources": [
        {
          "type": "providers/diagnosticSettings",
          "name": "[concat('Microsoft.Insights/', 'service')]",
          "dependsOn": [
            "[resourceId('Microsoft.Network/applicationGateways', parameters('appGatewaySettings').name)]"
          ],
          "apiVersion": "2017-05-01-preview",
          "properties": {
            "name": "service",
            "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
            "logs": [
              {
                "category": "ApplicationGatewayAccessLog",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              },
              {
                "category": "ApplicationGatewayPerformanceLog",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              },
              {
                "category": "ApplicationGatewayFirewallLog",
                "enabled": true,
                "retentionPolicy": {
                  "days": 0,
                  "enabled": false
                }
              }
            ],
            "metrics": [
              {
                "timeGrain": "PT1M",
                "enabled": true,
                "retentionPolicy": {
                  "enabled": false,
                  "days": 0
                }
              }
            ]
          }
        }
      ]
    }
  ]
}
